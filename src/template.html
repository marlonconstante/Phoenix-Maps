<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <style>
      @@include('./src/svg/%name%.css')
      html, body, #map {
        margin: 0;
        width: 100%;
        height: 100%;
      }
      #map {
        width: %width%;
        height: %height%;
        -webkit-backface-visibility: initial !important;
        -webkit-transform-origin: 50% 50%;
      }
      #myLocation, #arrow {
        display: none;
        position: absolute;
        stroke-width: 1;
      }
      #myLocation {
        stroke: #d08e00;
      }
      #arrow {
        stroke: #0079ff;
      }
    </style>
  </head>

  <body>
    <div id="map">
      @@include('./src/svg/%name%.svg')
      @@include('./src/svg/arrow.svg')
      @@include('./src/svg/myLocation.svg')
    </div>

    <script src="lib/jquery.js"></script>
    <script src="lib/jquery.panzoom.js"></script>
    <script src="lib/jquery.mousewheel.js"></script>
    <script>
      var QueryString = function () {
        // This function is anonymous, is executed immediately and
        // the return value is assigned to QueryString!
        var query_string = {};
        var query = location.search.substring(1);
        var vars = query.split("&");
        for (var i=0; i<vars.length; i++) {
          var pair = vars[i].split("=");
            // If first entry with this name
          if (typeof query_string[pair[0]] === "undefined") {
            query_string[pair[0]] = pair[1];
            // If second entry with this name
          } else if (typeof query_string[pair[0]] === "string") {
            var arr = [ query_string[pair[0]], pair[1] ];
            query_string[pair[0]] = arr;
            // If third or later entry with this name
          } else {
            query_string[pair[0]].push(pair[1]);
          }
        }
        return query_string;
      }();

      // Utilities to manipulate svg elements
      var SvgUtils = {
        getSvgSize: function(element) {
            var $svg = $(element).closest("svg");
            return {
              width: $svg.width(),
              height: $svg.height()
            };
        },
        getSvgBoxSize: function(element) {
          return $(element).closest("svg")[0].getBBox();
        },
        getCenterX: function(element, scale) {
          if (element) {
            var x = SvgUtils.getX(element);
            x = x + (x - $("#map").width() / 2);
            return x + ($("#map").width() - $("body").width()) / scale;
          }
          return 0;
        },
        getCenterY: function(element, scale) {
          if (element) {
            var y = SvgUtils.getY(element);
            y = y + (y - $("#map").height() / 2);
            return y + ($("#map").height() - $("body").height()) / scale;
          }
          return 0;
        },
        getX: function(element) {
          return (element.getBBox().x * SvgUtils.getSvgSize(element).width) / SvgUtils.getSvgBoxSize(element).width;
        },
        getY: function(element) {
          return (element.getBBox().y * SvgUtils.getSvgSize(element).height) / SvgUtils.getSvgBoxSize(element).height;
        },
        getWidth: function(element) {
          return (element.getBBox().width * SvgUtils.getSvgSize(element).width) / SvgUtils.getSvgBoxSize(element).width;
        },
        getHeight: function(element) {
          return (element.getBBox().height * SvgUtils.getSvgSize(element).height) / SvgUtils.getSvgBoxSize(element).height;
        },
        showAndMove: function(idElement, IdReference, horizontalMiddle, verticalMiddle) {
          var $element = $("#" + idElement);
          var $reference = $("#" + IdReference);
          if ($reference.length > 0) {
            $element.css({
              display: "block",
              left: SvgUtils.getX($reference[0]) + (horizontalMiddle ? SvgUtils.getWidth($reference[0]) / 2 : 0) - $element.width() / 2,
              top: SvgUtils.getY($reference[0]) + (verticalMiddle ? SvgUtils.getHeight($reference[0]) / 2 : 0) - $element.height()
            });
          }
        },
        mobile: {
          Android: function() {
              return /Android/i.test(navigator.userAgent);
          },
          BlackBerry: function() {
              return /BlackBerry/i.test(navigator.userAgent);
          },
          iOS: function() {
              return /iPhone|iPad|iPod/i.test(navigator.userAgent);
          },
          Windows: function() {
              return /IEMobile/i.test(navigator.userAgent);
          },
          any: function() {
              return (SvgUtils.mobile.Android() || SvgUtils.mobile.BlackBerry() || SvgUtils.mobile.iOS() || SvgUtils.mobile.Windows());
          }
        },
        minScale: function() {
          var bodyHeight = $("body").height();
          var mapHeight = $("#map").height();

          if (SvgUtils.mobile.iOS()) {
            bodyHeight -= 64;
          } else if (SvgUtils.mobile.Android()) {
            bodyHeight -= 48;
          }

          return 1 + (bodyHeight - mapHeight) * 100 / (bodyHeight * 100);
        },
        zoomAt: function(element, scale, locationCode, sectorCode) {
          var $sector = $("#" + sectorCode);
          $sector.css("fill", "#5eaaff");
          $sector.css("stroke", "#0079ff");
          $sector.css("stroke-width", "80");

          SvgUtils.showAndMove("myLocation", locationCode, true, true);
          SvgUtils.showAndMove("arrow", sectorCode, true, false);

          var $map = $("#map");

          scale = element ? scale : 1;
          if (scale == 1)
          {
            var x = ($map.width() - $("body").width()) / 2;
            $map.panzoom("pan", -x, 0);
          }

          $map.panzoom("zoom", scale,
            {
              animate: true,
              focal: {
                clientX: SvgUtils.getCenterX(element, scale),
                clientY: SvgUtils.getCenterY(element, scale)
              }
            }
          );
        }
      };

      (function() {
        $("#map").panzoom({
          maxScale: 5,
          minScale: SvgUtils.minScale(),
          increment: 0.5,
          contain: "invert"
        });

        var element = $("#" + QueryString.zoomIn)[0];
        SvgUtils.zoomAt(element, Number(QueryString.scale || 1), QueryString.locationCode || "", QueryString.sectorCode || "");
      })();
    </script>

  </body>

</html>
